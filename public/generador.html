<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Números Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-slate-950 text-white font-sans">

    <div class="min-h-screen flex flex-col items-center justify-center px-6 py-10">
        <div class="w-full max-w-2xl bg-slate-900 p-8 rounded-2xl border border-slate-800 shadow-2xl">
            <h1 class="text-3xl font-bold mb-6 text-center text-blue-500">Generador de Números Pro</h1>
            
            <div class="bg-slate-800/30 p-6 rounded-xl border border-slate-700 mb-8">
                <h2 class="text-lg font-semibold mb-4 text-blue-400"><i class="fa-solid fa-layer-group mr-2"></i>Generación Masiva por Operador</h2>
                <div class="grid md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block mb-2 text-sm font-medium text-slate-400">Cantidad</label>
                        <input type="number" id="cantidad" class="w-full p-3 bg-slate-800 border border-slate-700 rounded-lg text-white outline-none focus:border-blue-500" value="1000">
                    </div>
                    <div>
                        <label class="block mb-2 text-sm font-medium text-slate-400">Operador</label>
                        <select id="operador" class="w-full p-3 bg-slate-800 border border-slate-700 rounded-lg text-white outline-none focus:border-blue-500">
                            <option value="TODOS">Todos (Aleatorio)</option>
                            <option value="MOVISTAR">Movistar</option>
                            <option value="VODAFONE">Vodafone</option>
                            <option value="ORANGE">Orange</option>
                            <option value="YOIGO">Yoigo</option>
                            <option value="DIGI">Digi</option>
                            <option value="JAZZTEL">Jazztel</option>
                            <option value="LEBARA">Lebara</option>
                        </select>
                    </div>
                </div>
                <button id="generarBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-all flex items-center justify-center gap-2">
                    <i class="fa-solid fa-bolt"></i> Generar por Operador
                </button>
            </div>

            <div class="bg-slate-800/30 p-6 rounded-xl border border-slate-700 mb-8">
                <h2 class="text-lg font-semibold mb-4 text-cyan-400"><i class="fa-solid fa-dna mr-2"></i>Generar por Cabecera</h2>
                <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block mb-2 text-sm font-medium text-slate-400">Números Semilla</label>
                        <input type="text" id="seedInput" placeholder="Ej: 660508437" class="w-full p-3 bg-slate-800 border border-slate-700 rounded-lg text-white outline-none focus:border-cyan-500">
                    </div>
                    <div>
                        <label class="block mb-2 text-sm font-medium text-slate-400">Cantidad por Cabecera</label>
                        <input type="number" id="cantidadSeed" value="5000" class="w-full p-3 bg-slate-800 border border-slate-700 rounded-lg text-white outline-none focus:border-cyan-500">
                    </div>
                </div>
                <button id="generarSeedBtn" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 rounded-lg transition-all flex items-center justify-center gap-2">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> Expandir Cabeceras
                </button>
            </div>

            <div class="flex items-center justify-between mb-4 px-2">
                <span id="contador" class="text-sm text-slate-400 italic">Listo para generar</span>
                <button id="descargarBtn" disabled class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg transition-all flex items-center justify-center gap-2 disabled:opacity-30">
                    <i class="fa-solid fa-file-csv"></i> Descargar CSV
                </button>
            </div>

            <textarea id="resultado" readonly placeholder="Los números aparecerán aquí..."
                      class="w-full h-64 p-4 bg-slate-950 border border-slate-800 rounded-xl font-mono text-sm text-blue-400 outline-none resize-none focus:border-blue-500">
            </textarea>
        </div>
    </div>

<script>
    const prefijosMapa = {
        'MOVISTAR': ['600', '604', '605', '606', '609', '619', '629', '630', '639', '650', '659', '670', '679', '696', '699'],
        'VODAFONE': ['607', '608', '610', '617', '627', '649', '660', '661', '662', '663', '664', '665', '666', '667', '668', '669'],
        'ORANGE':   ['615', '616', '618', '625', '642', '643', '646', '647', '648', '651', '652', '653', '671', '672', '673', '674', '675', '676', '677', '681', '682', '683', '689'],
        'YOIGO':    ['622'],
        'DIGI':     ['722'],
        'JAZZTEL':  ['640', '644', '645'],
        'LEBARA':   ['632', '634', '694'],
        'MASMOVIL': ['623', '633', '693'],
        'TODOS': [] 
    };
    prefijosMapa.TODOS = Object.values(prefijosMapa).flat();

    let numerosGenerados = [];

    function actualizarUI(lista) {
        numerosGenerados = lista;
        document.getElementById('resultado').value = lista.slice(0, 3000).join('\n') + 
            (lista.length > 3000 ? `\n\n... [+${(lista.length - 3000).toLocaleString()} adicionales]` : '');
        document.getElementById('contador').innerText = `✨ ${lista.length.toLocaleString()} números únicos listos`;
        document.getElementById('descargarBtn').disabled = false;
    }

    // 1. GENERADOR TRADICIONAL
    document.getElementById('generarBtn').addEventListener('click', function() {
        const cantidad = parseInt(document.getElementById('cantidad').value);
        const opSeleccionado = document.getElementById('operador').value;
        const btn = this;

        btn.disabled = true;
        setTimeout(() => {
            const conjunto = new Set();
            const prefijos = prefijosMapa[opSeleccionado];
            while (conjunto.size < cantidad) {
                const pre = prefijos[Math.floor(Math.random() * prefijos.length)];
                const suf = Math.floor(100000 + Math.random() * 900000).toString();
                conjunto.add(pre + suf);
            }
            actualizarUI(Array.from(conjunto));
            btn.disabled = false;
        }, 50);
    });

    // 2. GENERADOR POR CABECERA CON CANTIDAD MANUAL
    document.getElementById('generarSeedBtn').addEventListener('click', async function() {
        const input = document.getElementById('seedInput').value;
        const cantidadManual = parseInt(document.getElementById('cantidadSeed').value) || 5000;
        // Limpiar el input: quitar espacios y posibles "34" al inicio de cada número
        const cabeceras = input.split(/[\s,]+/).filter(n => n.length >= 3).map(n => n.startsWith('34') ? n.substring(2) : n);
        const btn = this;

        if (cabeceras.length === 0) {
            alert("Ingresa al menos un número de cabecera");
            return;
        }

        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Generando...';
        btn.disabled = true;

        try {
            const response = await fetch('/api/expandir-cabeceras', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    cabeceras: cabeceras, 
                    cantidadPorCabecera: cantidadManual 
                })
            });

            const data = await response.json();
            if (data.error) throw new Error(data.error);

            actualizarUI(data.numeros);
        } catch (err) {
            alert("Error: " + err.message);
        } finally {
            btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> Expandir Cabeceras';
            btn.disabled = false;
        }
    });

    // 3. DESCARGA CSV (FORZANDO MODO TEXTO PARA EXCEL)
    document.getElementById('descargarBtn').addEventListener('click', function() {
        // Usamos \ufeff al inicio para que Excel detecte UTF-8
        // Y añadimos una comilla simple o forzamos el formato para evitar notación científica
        const contenido = "Numero\n" + numerosGenerados.join("\n");
        const blob = new Blob(["\ufeff" + contenido], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `lista_numeros_${new Date().getTime()}.csv`;
        link.click();
    });
</script>
</body>
</html>